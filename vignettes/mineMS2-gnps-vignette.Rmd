---
title: 'MineMS2: Coupling with GNPS'
author: "Alexis Delabriere"
date: "22 octobre 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Introduction

This vignette highlights the use of the _MineMS2_ software coupled to the GNPS MS-MS networking methodology. The GNPS network may be generated directly from the *ex_mgf.mgf* file present in the *dataset* subdirectory of your _MineMS2_ installation. In this example the GNPS network has been precomputed on the GNPS website and extracted, the *.graphML* file  *ex_gnps_network.graphml* is present inside the *dataset* subdirectory. I strongly recommend to compute the patterns and the GNPS network on the same .mgf file to avoir matching issues.


# Pre-requisites

## Pattern computation.
The patterns computations step is described in more detail in the [MineMS2 main vignette] (mineMS2-vignette.html). We juste do a quick computation on this dataset.




##Initialisation
The initialization loads the required pakages and extract the data paths.
```{r path_gnps}
library(mineMS2)
path_demo <- system.file("dataset",package="mineMS2")
path_network <- file.path(path_demo,"ex_gnps_network.graphml")
path_mgf <- file.path(path_demo,"ex_mgf.mgf")
```

##Dataset
The considered dataset is a dataset pf E.coli used in the secondary experiments.

##Reading the GNPS network
The GNPS network may be read using the *igraph* package :
```{r gnps_network_reading}
library(igraph)

net_gnps <- read_graph(path_network, "graphml")
```

However to avoid the inclusion of meaningless components, we start by removing the self-edges which are added by GNPS :

```{r simplify_network}
net_gnps <- simplify(net_gnps,remove.multiple = FALSE,edge.attr.comb = "ignore")
```

## Extracting components from an MS-MS network.

Then the connected components and the cliques may be extracted using the *findGNPSComponents* function. The important parameters of this function are the _minSize_ parameter which idicate the minimum size of the detected cliques and the _pairThreshold_ threshold which indicate a similarity threshold for which an exaplantion of a single edge is generated.
```{r gnps_components}
components <- findGNPSComponents(net_gnps,minSize=3,pairThreshold = 0.9)
```
The results of this function is a list of graph components which could potentially be explained by a pattern.

## Computing patterns.
Here we compute the patterns for the same set of MS-MS spectra than the MS2 software. The ocmputing is described in more detail in the mineMS2 vignette.
```{r pattern_computing,message=FALSE}
m2l <- ms2Lib(path_mgf,intThreshold = 3000)
m2l <- discretizeMassLosses(m2l,dmz = 0.008,ppm=8,heteroAtoms=FALSE,maxFrags=15)
m2l <- mineClosedSubgraphs(m2l,sizeMin=1,count=2)
```
## Finding patterns explaining components.

MineMS2 implement a matching between components and subgraphs occurences using metrics related to binary classification, notably the _recall_, the _precision_ and the _F1-score_ [(more information)](https://en.wikipedia.org/wiki/F1_score). The pattern maximizing the given metric are returned, in case of tie a second metrics may be used. In the case of GNPS matching a we set the metric argument to `c("recall","f1","size")` to indicate that a pattern maximizing recall is extracted for each components, we then use accuracy and size to obtain a specific pattern as possible. This will reduce the number of explaining pattern to 1 by components.
```{r patterns_explaining_components}
patterns <- findPatternsExplainingComponents(m2l,components,metric=c("recall","accuracy","size"))
```

The returned quantity is a list which include all the metrics for the given patterns, aswell as the id of the found explaining patterns.
```{r pattern_showing}
patterns[[1]]
```
It if useful to extract the pattern ids `r ids <- sapply(patterns,'[',i=1,j="id")`.


These patterns can then be observed using the _plot_ and _plotOccurences_ functions, which are wrapped inside the _plotPatterns_ function for commodity purpose. This function may be easely coupled to a pdf output.
```{r pattern_plotting}
###Here a single id is selected for lisibility purpose.
plotPatterns(m2l,ids[3],components = components[3])
```
 FInally the exported compoent can be used to directly annotate the network.
